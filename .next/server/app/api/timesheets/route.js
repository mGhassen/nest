"use strict";(()=>{var e={};e.id=158,e.ids=[158],e.modules={92885:e=>{e.exports=require("@supabase/supabase-js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},96119:e=>{e.exports=require("perf_hooks")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},54691:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>g,routeModule:()=>v,serverHooks:()=>q,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>R});var s={};t.r(s),t.d(s,{GET:()=>f,POST:()=>c});var i=t(52412),a=t(14293),n=t(94147),o=t(77856),d=t(7219),p=t(38083),u=t(53544),l=t(86461),m=t(39260),w=t(23498),y=t(26475);let h=y.z.object({employeeId:y.z.string(),weekStart:y.z.string().transform(e=>new Date(e)),entries:y.z.array(y.z.object({date:y.z.string().transform(e=>new Date(e)),project:y.z.string().optional(),hours:y.z.number().min(0).max(24),notes:y.z.string().optional()}))});async function f(e){try{let r=await (0,d.getServerSession)(p.a);if(!r?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,m.wN)(r.user.id);if(!t)return o.NextResponse.json({error:"User not found"},{status:404});if(!(0,m.BT)(t.role,"read","timesheet"))return o.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:s}=new URL(e.url),i=s.get("weekStart"),a=s.get("employeeId"),n=u.db.query.timesheets.findMany({with:{employee:!0,entries:!0}});if(i){let e=new Date(i),r=new Date(e);r.setDate(r.getDate()+7),n=u.db.query.timesheets.findMany({where:(0,w.xD)((0,w.eg)(l.timesheets.weekStart,e),(0,w.G)(l.timesheets.weekStart,r)),with:{employee:!0,entries:!0}})}if(a){if("EMPLOYEE"===t.role){let e=await u.db.query.employees.findFirst({where:(0,w.eq)(employees.userId,t.id)});if(e?.id!==a)return o.NextResponse.json({error:"Forbidden"},{status:403})}else if("MANAGER"===t.role){let e=await u.db.query.employees.findFirst({where:(0,w.eq)(employees.id,a)});if(e?.managerId!==t.id)return o.NextResponse.json({error:"Forbidden"},{status:403})}n=u.db.query.timesheets.findMany({where:(0,w.eq)(l.timesheets.employeeId,a),with:{employee:!0,entries:!0}})}let y=await n;return o.NextResponse.json(y)}catch(e){return console.error("Error fetching timesheets:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){try{let r=await (0,d.getServerSession)(p.a);if(!r?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,m.wN)(r.user.id);if(!t)return o.NextResponse.json({error:"User not found"},{status:404});if(!(0,m.BT)(t.role,"write","timesheet"))return o.NextResponse.json({error:"Forbidden"},{status:403});let s=await e.json(),i=h.parse(s);if("EMPLOYEE"===t.role){let e=await u.db.query.employees.findFirst({where:(0,w.eq)(employees.userId,t.id)});if(e?.id!==i.employeeId)return o.NextResponse.json({error:"Forbidden"},{status:403})}let a=await u.db.insert(l.timesheets).values({employeeId:i.employeeId,weekStart:i.weekStart,status:"DRAFT"}).returning(),n=i.entries.map(e=>({timesheetId:a[0].id,...e}));return await u.db.insert(l.timesheetEntries).values(n),o.NextResponse.json(a[0],{status:201})}catch(e){if(e instanceof y.z.ZodError)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error creating timesheet:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/timesheets/route",pathname:"/api/timesheets",filename:"route",bundlePath:"app/api/timesheets/route"},resolvedPagePath:"/Users/mghassen/Workspace/GPRD/nest/app/api/timesheets/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:R,serverHooks:q}=v;function g(){return(0,n.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:R})}},39260:(e,r,t)=>{t.d(r,{BT:()=>d,IV:()=>p,Qg:()=>l,uL:()=>u,wN:()=>o});var s=t(53544),i=t(86461),a=t(23498);let n={OWNER:{employee:["read","write","delete","approve","admin"],timesheet:["read","write","delete","approve","admin"],leave:["read","write","delete","approve","admin"],payroll:["read","write","delete","approve","admin"],company:["read","write","delete","approve","admin"],settings:["read","write","delete","approve","admin"]},ADMIN:{employee:["read","write","delete","approve","admin"],timesheet:["read","write","delete","approve","admin"],leave:["read","write","delete","approve","admin"],payroll:["read","write","delete","approve","admin"],company:["read","write","admin"],settings:["read","write","admin"]},HR:{employee:["read","write","approve"],timesheet:["read","approve"],leave:["read","write","approve"],payroll:["read","write","approve"],company:["read","write"],settings:["read","write"]},MANAGER:{employee:["read"],timesheet:["read","approve"],leave:["read","approve"],payroll:["read"],company:["read"],settings:["read"]},EMPLOYEE:{employee:["read"],timesheet:["read","write"],leave:["read","write"],payroll:["read"],company:["read"],settings:["read"]}};async function o(e){let r=await s.db.query.users.findFirst({where:(0,a.eq)(i.users.id,e),with:{memberships:{with:{company:!0}}}});return r&&r.memberships?.[0]?{id:r.id,email:r.email,role:r.memberships[0].role,companyId:r.memberships[0].companyId}:null}function d(e,r,t){return n[e]?.[t]?.includes(r)||!1}async function p(e,r){let t=await o(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.employees.findFirst({where:(0,a.eq)(i.employees.id,r)});return t?.managerId===e}if("EMPLOYEE"===t.role){let t=await s.db.query.employees.findFirst({where:(0,a.eq)(i.employees.id,r)});return t?.userId===e}return!1}async function u(e,r){let t=await o(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.timesheets.findFirst({where:(0,a.eq)(timesheets.id,r),with:{employee:!0}});return t?.employee?.managerId===e}return!1}async function l(e,r){let t=await o(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.leaveRequests.findFirst({where:(0,a.eq)(leaveRequests.id,r),with:{employee:!0}});return t?.employee?.managerId===e}return!1}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[147,706,715,856,997],()=>t(54691));module.exports=s})();