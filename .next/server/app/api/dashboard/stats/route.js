"use strict";(()=>{var e={};e.id=41,e.ids=[41],e.modules={92885:e=>{e.exports=require("@supabase/supabase-js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},79348:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30412:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},96119:e=>{e.exports=require("perf_hooks")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},83418:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>E,routeModule:()=>q,serverHooks:()=>R,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{GET:()=>h});var a=t(52412),i=t(14293),o=t(94147),n=t(77856),d=t(7219),p=t(38083),l=t(53544),u=t(86461),m=t(39260),c=t(65431);function y(e){return(0,c.i6)`count(${e||c.i6.raw("*")})`.mapWith(Number)}var w=t(23498);async function h(e){try{let e=await (0,d.getServerSession)(p.a);if(!e?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=await (0,m.wN)(e.user.id);if(!r)return n.NextResponse.json({error:"User not found"},{status:404});let t=await l.db.select({count:y()}).from(u.employees).where((0,w.eq)(u.employees.companyId,r.companyId)),s=await l.db.select({count:y()}).from(u.timesheets).where((0,w.xD)((0,w.eq)(u.timesheets.status,"SUBMITTED"),(0,c.i6)`${u.timesheets.employeeId} IN (
            SELECT id FROM employees WHERE company_id = ${r.companyId}
          )`)),a=await l.db.select({count:y()}).from(u.leaveRequests).where((0,w.xD)((0,w.eq)(u.leaveRequests.status,"SUBMITTED"),(0,c.i6)`${u.leaveRequests.employeeId} IN (
            SELECT id FROM employees WHERE company_id = ${r.companyId}
          )`)),i=await l.db.select({count:y()}).from(u.payrollCycles).where((0,w.xD)((0,w.eq)(u.payrollCycles.companyId,r.companyId),(0,w.eq)(u.payrollCycles.status,"DRAFT"))),o={};if("EMPLOYEE"===r.role){let e=await l.db.query.employees.findFirst({where:(0,w.eq)(u.employees.userId,r.id)});if(e){let r=await l.db.select({count:y()}).from(u.timesheets).where((0,w.xD)((0,w.eq)(u.timesheets.employeeId,e.id),(0,w.eq)(u.timesheets.status,"SUBMITTED"))),t=await l.db.select({count:y()}).from(u.leaveRequests).where((0,w.xD)((0,w.eq)(u.leaveRequests.employeeId,e.id),(0,w.eq)(u.leaveRequests.status,"SUBMITTED")));o={myPendingTimesheets:r[0].count,myPendingLeaveRequests:t[0].count}}}else if("MANAGER"===r.role){let e=await l.db.query.employees.findMany({where:(0,w.eq)(u.employees.managerId,r.id)}),t=e.map(e=>e.id),s=await l.db.select({count:y()}).from(u.timesheets).where((0,w.xD)((0,c.i6)`${u.timesheets.employeeId} IN (${c.i6.join(t,(0,c.i6)`, `)})`,(0,w.eq)(u.timesheets.status,"SUBMITTED"))),a=await l.db.select({count:y()}).from(u.leaveRequests).where((0,w.xD)((0,c.i6)`${u.leaveRequests.employeeId} IN (${c.i6.join(t,(0,c.i6)`, `)})`,(0,w.eq)(u.leaveRequests.status,"SUBMITTED")));o={directReportsCount:e.length,directReportsPendingTimesheets:s[0].count,directReportsPendingLeaveRequests:a[0].count}}let h={totalEmployees:t[0].count,pendingTimesheets:s[0].count,pendingLeaveRequests:a[0].count,activePayrollCycles:i[0].count,...o};return n.NextResponse.json(h)}catch(e){return console.error("Error fetching dashboard stats:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let q=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/dashboard/stats/route",pathname:"/api/dashboard/stats",filename:"route",bundlePath:"app/api/dashboard/stats/route"},resolvedPagePath:"/Users/mghassen/Workspace/GPRD/nest/app/api/dashboard/stats/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:v,workUnitAsyncStorage:f,serverHooks:R}=q;function E(){return(0,o.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:f})}},39260:(e,r,t)=>{t.d(r,{BT:()=>d,IV:()=>p,Qg:()=>u,uL:()=>l,wN:()=>n});var s=t(53544),a=t(86461),i=t(23498);let o={OWNER:{employee:["read","write","delete","approve","admin"],timesheet:["read","write","delete","approve","admin"],leave:["read","write","delete","approve","admin"],payroll:["read","write","delete","approve","admin"],company:["read","write","delete","approve","admin"],settings:["read","write","delete","approve","admin"]},ADMIN:{employee:["read","write","delete","approve","admin"],timesheet:["read","write","delete","approve","admin"],leave:["read","write","delete","approve","admin"],payroll:["read","write","delete","approve","admin"],company:["read","write","admin"],settings:["read","write","admin"]},HR:{employee:["read","write","approve"],timesheet:["read","approve"],leave:["read","write","approve"],payroll:["read","write","approve"],company:["read","write"],settings:["read","write"]},MANAGER:{employee:["read"],timesheet:["read","approve"],leave:["read","approve"],payroll:["read"],company:["read"],settings:["read"]},EMPLOYEE:{employee:["read"],timesheet:["read","write"],leave:["read","write"],payroll:["read"],company:["read"],settings:["read"]}};async function n(e){let r=await s.db.query.users.findFirst({where:(0,i.eq)(a.users.id,e),with:{memberships:{with:{company:!0}}}});return r&&r.memberships?.[0]?{id:r.id,email:r.email,role:r.memberships[0].role,companyId:r.memberships[0].companyId}:null}function d(e,r,t){return o[e]?.[t]?.includes(r)||!1}async function p(e,r){let t=await n(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.employees.findFirst({where:(0,i.eq)(a.employees.id,r)});return t?.managerId===e}if("EMPLOYEE"===t.role){let t=await s.db.query.employees.findFirst({where:(0,i.eq)(a.employees.id,r)});return t?.userId===e}return!1}async function l(e,r){let t=await n(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.timesheets.findFirst({where:(0,i.eq)(timesheets.id,r),with:{employee:!0}});return t?.employee?.managerId===e}return!1}async function u(e,r){let t=await n(e);if(!t)return!1;if(["OWNER","ADMIN","HR"].includes(t.role))return!0;if("MANAGER"===t.role){let t=await s.db.query.leaveRequests.findFirst({where:(0,i.eq)(leaveRequests.id,r),with:{employee:!0}});return t?.employee?.managerId===e}return!1}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[147,706,715,856,997],()=>t(83418));module.exports=s})();